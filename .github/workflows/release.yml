name: Build and Release Ultra World

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract game version
        id: version
        shell: pwsh
        run: |
          $content = Get-Content "client/application.nvgt" -Raw
          if ($content -match 'this\.version\s*=\s*"([^"]+)"') {
            $version = $Matches[1]
          } else {
            $version = "0.0.0"
          }
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG=v${version}-${shortSha}" >> $env:GITHUB_OUTPUT
          echo "Game version: $version"



      - name: Download NVGT compiler
        shell: pwsh
        run: |
          $headers = @{ "Accept" = "application/vnd.github.v3+json" }
          # NVGT uses "latest" as a literal git tag name for bleeding-edge builds
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/samtupy/nvgt/releases/tags/latest" -Headers $headers
          $winAsset = $release.assets | Where-Object { $_.name -match '^nvgt_.*\.exe$' } | Select-Object -First 1
          if (-not $winAsset) {
            Write-Error "Could not find NVGT Windows installer in the latest release"
            exit 1
          }
          Write-Host "Downloading NVGT: $($winAsset.name) ($([math]::Round($winAsset.size / 1MB, 1)) MB)"
          Invoke-WebRequest -Uri $winAsset.browser_download_url -OutFile "nvgt_setup.exe"
          
          # Verify the download
          if (-not (Test-Path "nvgt_setup.exe")) {
            Write-Error "Download failed: nvgt_setup.exe not found"
            exit 1
          }
          $fileSize = (Get-Item "nvgt_setup.exe").Length
          Write-Host "Downloaded file size: $([math]::Round($fileSize / 1MB, 1)) MB"
          if ($fileSize -lt 1MB) {
            Write-Error "Downloaded file is too small (likely incomplete or corrupted)"
            exit 1
          }

      - name: Install NVGT compiler
        shell: pwsh
        run: |
          Write-Host "Installing NVGT using silent installation..."
          
          # Run the Inno Setup installer in silent mode
          # /VERYSILENT = no messages, /SUPPRESSMSGBOXES = no message boxes
          # /NORESTART = don't restart, /SP- = skip startup prompt
          # /DIR = installation directory
          # /LOG = enable logging for debugging
          $installDir = Join-Path $PWD "nvgt"
          $logFile = Join-Path $PWD "nvgt_install.log"
          Write-Host "Installing to: $installDir"
          Write-Host "Log file: $logFile"
          
          $process = Start-Process -FilePath "nvgt_setup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-", "/DIR=`"$installDir`"", "/LOG=`"$logFile`"" -Wait -PassThru
          
          if ($process.ExitCode -ne 0) {
            Write-Error "NVGT installation failed with exit code: $($process.ExitCode)"
            if (Test-Path $logFile) {
              Write-Host "`nInstallation log (last 50 lines):"
              Get-Content $logFile -Tail 50
            }
            exit 1
          }
          
          # Wait a moment for filesystem operations to complete
          Write-Host "Installation completed. Waiting for filesystem to sync..."
          Start-Sleep -Seconds 3
          
          Write-Host "Searching for nvgtc.exe..."
          
          # List contents for debugging
          Write-Host "`nInstallation directory structure:"
          if (Test-Path $installDir) {
            Get-ChildItem -Path $installDir -Recurse -ErrorAction SilentlyContinue | Select-Object -First 50 FullName | Format-Table -AutoSize
          } else {
            Write-Host "ERROR: Installation directory does not exist!"
          }
          
          # Search for nvgtc.exe in the installation directory
          $nvgtc = Get-ChildItem -Path $installDir -Recurse -Filter "nvgtc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          # If not found in custom directory, check common install locations
          if (-not $nvgtc) {
            Write-Host "`nSearching in Program Files..."
            $programFiles = @($env:ProgramFiles, ${env:ProgramFiles(x86)})
            foreach ($pf in $programFiles) {
              if ($pf -and (Test-Path $pf)) {
                $nvgtc = Get-ChildItem -Path $pf -Recurse -Filter "nvgtc.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($nvgtc) { break }
              }
            }
          }
          
          if (-not $nvgtc) {
            Write-Error "Could not find nvgtc.exe after installation"
            Write-Host "`nInstallation log (last 100 lines):"
            if (Test-Path $logFile) {
              Get-Content $logFile -Tail 100
            }
            exit 1
          }
          
          Write-Host "Found NVGT compiler at: $($nvgtc.FullName)"
          echo "NVGTC=$($nvgtc.FullName)" >> $env:GITHUB_ENV

      - name: Compile server
        shell: pwsh
        run: |
          Write-Host "Compiling Ultra World Server..."
          Push-Location server
          & "$env:NVGTC" uwserver.nvgt -q
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Server compilation failed"
            exit 1
          }
          Pop-Location
          if (Test-Path "server/uwserver.exe") {
            Write-Host "Server compiled successfully: uwserver.exe"
          } else {
            Write-Error "Server executable not found after compilation"
            exit 1
          }

      - name: Compile client
        shell: pwsh
        run: |
          Write-Host "Compiling Ultra World Client..."
          Push-Location client
          & "$env:NVGTC" includes.nvgt -o uw.exe -q
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Client compilation failed"
            exit 1
          }
          Pop-Location
          if (Test-Path "client/uw.exe") {
            Write-Host "Client compiled successfully: uw.exe"
          } else {
            Write-Error "Client executable not found after compilation"
            exit 1
          }

      - name: Package release
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipName = "UltraWorld-v${version}.zip"
          $stagingDir = "UltraWorld"

          # Create staging directory
          New-Item -ItemType Directory -Path $stagingDir -Force | Out-Null

          # Copy launcher scripts
          Copy-Item "launch_ultraworld.bat" "$stagingDir/"
          Copy-Item "start_server.bat" "$stagingDir/"
          Copy-Item "start_client.bat" "$stagingDir/"

          # Copy server files
          New-Item -ItemType Directory -Path "$stagingDir/server" -Force | Out-Null
          Copy-Item "server/uwserver.exe" "$stagingDir/server/"
          if (Test-Path "server/maps") {
            Copy-Item "server/maps" "$stagingDir/server/maps" -Recurse
          }
          if (Test-Path "server/changelogs") {
            Copy-Item "server/changelogs" "$stagingDir/server/changelogs" -Recurse
          }

          # Copy client files
          New-Item -ItemType Directory -Path "$stagingDir/client" -Force | Out-Null
          Copy-Item "client/uw.exe" "$stagingDir/client/"
          if (Test-Path "client/docs") {
            Copy-Item "client/docs" "$stagingDir/client/docs" -Recurse
          }
          if (Test-Path "client/uw.json") {
            Copy-Item "client/uw.json" "$stagingDir/client/"
          }

          # Copy license
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "$stagingDir/"
          }

          # Create zip
          Compress-Archive -Path "$stagingDir/*" -DestinationPath $zipName -Force
          $size = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
          Write-Host "Created release package: $zipName ($size MB)"
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: Ultra World ${{ steps.version.outputs.VERSION }}
          body: |
            ## Ultra World ${{ steps.version.outputs.VERSION }}

            ### Quick Start
            1. Download `UltraWorld-v${{ steps.version.outputs.VERSION }}.zip` below
            2. Extract the zip file
            3. Run `launch_ultraworld.bat` to start both server and client
               - Or run `start_server.bat` to host a server for friends
               - Or run `start_client.bat` to just launch the game client

            ### Hosting a Server for Friends
            1. Run `start_server.bat` - the server starts on port **6200**
            2. Share your IP address with friends
            3. Friends run `start_client.bat` and connect to your IP

            ### Playing Online
            Run `start_client.bat` to connect to the official Ultra World server.

            *Built from commit ${{ github.sha }}*
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
          make_latest: true
